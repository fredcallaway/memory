---
title: Rational metacognition in memory w/ cued recall strength (all trials)
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
source("setup.r")
source("load_data_simple.r")

DROP_HALF = FALSE
DROP_ACC = TRUE

if (DROP_ACC) {
    keep_acc = multi %>% 
        group_by(wid) %>% 
        summarise(accuracy=mean(correct)) %>% 
        filter(accuracy > 0.5) %>% 
        with(wid)
    N_total = multi %>% with(length(unique(wid)))
    N_drop_acc = N_total - length(keep_acc)
    multi = multi %>% filter(wid %in% keep_acc)
}
if (DROP_HALF) {
    multi = multi %>% filter(trial_num > 10)
}

raw_df = bind_rows(
    read_sim("optimal_prior", noise_sd=1),
    read_sim("empirical_commitment", noise_sd=1),
    read_sim("empirical", noise_sd=1),
    multi %>% mutate(name = "human", wid = factor(wid))
) %>% mutate(
    name = recode_factor(name, .ordered=T,
        # "Optimal" = "optimal",
        "optimal_prior" = "Optimal",
        "human" = "Human",
        "empirical" = "Random",
        "empirical_commitment" = "Random Commitment",
        # "rand_gamma" = "Random",
    ),
    last_pres = if_else(n_pres %% 2 == 1, "first", "second")
)

df = raw_df %>% 
    filter(
        # response_type != "intrusion",
        response_type %in% c("correct", "timeout"),
        # abs(rel_strength) < 4.24,
        # abs(strength_first) < 3,
        # abs(strength_second) < 3,
    )

optimal = filter(df, name == "Optimal")
random = filter(df, name == "Random")
human = filter(df, name == "Human")
WIDTH = 7.5; HEIGHT = 2.5
```

```{r}
if (DROP_ACC) {
    cat(glue('Dropping {N_drop_acc} participants with less than 50% accuracy in critical trials'))
}
if (DROP_HALF) {
    cat("Dropping the first half of critical trials")
}
```

```{r, include=FALSE}
long = df %>% 
    group_by(name) %>%
    slice_sample(n=10000) %>% 
    make_fixations
```

Experiment versions: `r paste(VERSIONS)`

- Two rounds of training and pre-test
- No feedback in any pre-test trials
- Word stimuli are selected randomly (not selecting high/low recall probability and concreteness)
- Distractor task comes before final pre-test
- Strength is measured in the last round only
<!-- - **_Not_ excluding incorrect trials** -->


```{r}
# simple %>% 
#     filter(block == max(block)) %>% 
#     group_by(wid) %>% 
#     summarise(accuracy=mean(correct)) %>% 
#     with(mean(accuracy == 0))


# simple %>% 
#     filter(block == max(block)) %>% 
#     group_by(wid) %>% 
#     summarise(accuracy=mean(correct)) %>% 
#     ggplot(aes(accuracy)) + geom_density() +
#     coord_cartesian(xlim=c(0, 1.05), ylim=c(NULL))

```


# Main Results

## Fixation time course

```{r, time-course, fig.width=WIDTH, fig.height=3}

normalized_timestep = function(long) {
    long %>% 
        group_by(trial) %>%
        mutate(prop_duration = duration / sum(duration)) %>% 
        ungroup() %>% 
        mutate(n_step=round(prop_duration * 100)) %>% 
        uncount(n_step) %>% 
        group_by(trial) %>% 
        mutate(normalized_timestep = row_number())
}

long %>% 
    normalized_timestep %>% 
    drop_na(strength_diff) %>% 
    ggplot(aes(normalized_timestep/100, fix_stronger, group = strength_diff, color=strength_diff)) +
    geom_smooth(se=F) + 
    ylim(0, 1) +
    facet_grid(~name) +
    labs(x="Normalized Time", y="Probability Fixate\nStronger Cue", color="Strength Difference") +
    geom_hline(yintercept=0.5) +
    theme(legend.position="top")

participants
```

## Individual fixation durations

### First fixation

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(strength_first, first_pres_time) # plot
```

### Second fixation

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 3) %>% 
    regress(rel_strength, second_pres_time, bins=9) # plot
```

### Third fixation

```{r, third-fix, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 4) %>% 
    regress(rel_strength, third_pres_time)
```

## Overall fixation proportion

```{r, fix-prop, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(rel_strength, prop_first)
```

### Last-fixation effect

```{r, last-confound, fig.width=WIDTH, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    regress_interaction(rel_strength, last_pres, prop_first)
```

### Strength predicts last fixation 

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    mutate(last_pres_first = as.numeric(last_pres == "first")) %>% 
    regress(rel_strength, last_pres_first)
```

### Last fixations are longer

```{r, fix-by-final, fig.width=WIDTH, fig.height=HEIGHT}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_grid(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final")) +
    ylab("Duration")

last_diff = long %>% 
    filter(name == "Human") %>% 
    with(tapply(duration, last_fix, mean)) %>% 
    diff
```

```{r}
long %>% 
    filter(name == "Human") %>% 
    mutate(is_last = last_fix==1) %>% 
    lmer(duration ~ is_last + (is_last|wid), data=.) %>% 
    summ

```

# Sanity checks for evidence accumulation

These plots test basic predictions of the evidence
accumulation model, that is, effects that come out in the random model. 

These plots exclude timeout trials.

## Probability of remembering first word

```{r,remember-first, fig.width=WIDTH, fig.height=HEIGHT}

df %>%
    filter(response_type == "correct") %>% 
    mutate(choose_first = as.numeric(choose_first)) %>% 
    regress(rel_strength, choose_first) +
    ylab("Prob Select First Cue")
```

```{r}
# multi = multi %>% 
#     mutate(trial_num = row_number())

multi %>%
    filter(response_type == "correct") %>% 
    add_strength(block > 0, 2 * correct -log(rt)) %>% 
    mutate(choose_first = as.numeric(choose_first)) %>% 
    lmer(choose_first ~ rel_strength + (rel_strength|wid), data=.) %>% summ
    # glmer(choose_first ~ rel_strength + (rel_strength|wid), family='binomial', data=.) %>% summ
```

## Reaction time by chosen strength

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    regress(chosen_strength, rt)
```

## Last fixation duration by strength

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    filter(n_pres > 0) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    ) %>% 
    regress(last_strength, last_pres_time)
```

# Miscellaneous

## Response types

Note: The model can only predict correct answers and timeouts.

```{r}
raw_df %>% 
    with((proportions(table(name, response_type), margin=1))) %>% 
    kable(digits=2)

```

## Reaction time

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    ggplot(aes(rt)) +
    geom_density() +
    facet_grid(~name) +
    labs(x="Reaction Time", y="Density")
```


## Number of fixations

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres < 10) %>% 
    ggplot(aes(n_pres, ..prop..)) +
    geom_bar() +
    facet_grid(~name) +
    labs(x="Number of Fixations", y="Proportion of Trials")

```


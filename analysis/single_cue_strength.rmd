---
title: Rational metacognition in memory w/ cued recall strength
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
source("setup.r")
source("load_data_simple.r")
raw_df = bind_rows(
    read_sim("optimal_prior", noise_sd=1),
    read_sim("empirical_commitment", noise_sd=1),
    read_sim("empirical", noise_sd=1),
    multi %>% 
        mutate(name = "human", wid = factor(wid)) %>% 
        # filter(trial_num > 10) %>% # DROP FIRST HALF OF TRIALS
        identity
) %>% mutate(
    name = recode_factor(name, .ordered=T,
        # "Optimal" = "optimal",
        "optimal_prior" = "Optimal",
        "human" = "Human",
        "empirical" = "Random",
        "empirical_commitment" = "Random Commitment",
        # "rand_gamma" = "Random",
    ),
    last_pres = if_else(n_pres %% 2 == 1, "first", "second")
)

df = raw_df %>% 
    filter(
        response_type %in% c("correct", "timeout"),
        # abs(rel_strength) < 4.24,
        # abs(strength_first) < 3,
        # abs(strength_second) < 3,
    )

optimal = filter(df, name == "Optimal")
random = filter(df, name == "Random")
human = filter(df, name == "Human")
WIDTH = 7.5; HEIGHT = 2.5
```

```{r, include=FALSE}
long = df %>% 
    group_by(name) %>%
    slice_sample(n=10000) %>% 
    make_fixations
```


::: {.alert .alert-info}
**Changes from last pilot:** 

- Added an extra round of training.
- Using all pre-test trials because that predicts cue selection best. Results are similar
  when using only the last round as we did previously.

:::

N = `r nrow(participants)`


# Main Results

## Fixation time course

```{r, time-course, fig.width=WIDTH, fig.height=3}

normalized_timestep = function(long) {
    long %>% 
        group_by(trial) %>%
        mutate(prop_duration = duration / sum(duration)) %>% 
        ungroup() %>% 
        mutate(n_step=round(prop_duration * 100)) %>% 
        uncount(n_step) %>% 
        group_by(trial) %>% 
        mutate(normalized_timestep = row_number())
}

long %>% 
    normalized_timestep %>% 
    drop_na(strength_diff) %>% 
    ggplot(aes(normalized_timestep/100, fix_stronger, group = strength_diff, color=strength_diff)) +
    geom_smooth(se=F) + 
    ylim(0, 1) +
    facet_grid(~name) +
    labs(x="Normalized Time", y="Probability Fixate\nStronger Cue", color="Strength Difference") +
    geom_hline(yintercept=0.5) +
    theme(legend.position="top")
```

## Individual fixation durations

### First fixation

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(strength_first, first_pres_time) # plot
```

### Second fixation

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 3) %>% 
    regress(rel_strength, second_pres_time, bins=9) # plot
```

### Third fixation

```{r, third-fix, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 4) %>% 
    regress(rel_strength, third_pres_time)
```

## Overall fixation proportion

```{r, fix-prop, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(rel_strength, prop_first)
```

### Last-fixation effect

```{r, last-confound, fig.width=WIDTH, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    regress_interaction(rel_strength, last_pres, prop_first)
```

### Strength predicts last fixation 

```{r, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    mutate(last_pres_first = as.numeric(last_pres == "first")) %>% 
    regress(rel_strength, last_pres_first)
```

### Last fixations are longer

```{r, fix-by-final, fig.width=WIDTH, fig.height=HEIGHT}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_grid(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final")) +
    ylab("Duration")

last_diff = long %>% 
    filter(name == "Human") %>% 
    with(tapply(duration, last_fix, mean)) %>% 
    diff
```


```{r child = 'extra.rmd'}
```

---
title: Rational metacognition in memory (Pre-registered dataset)
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
---

```{r, include=FALSE}
VERSIONS = c('v5.6')
knitr::opts_chunk$set(
    fig.path="figs/",
    results='asis', warning=FALSE, message=FALSE, fig.width=5, fig.height=4, fig.align="center"
)
source("setup.r")
```

```{r}
load_data = function(type) {
    VERSIONS %>% 
    map(~ read_csv(glue('../data/{.x}/{type}.csv'), col_types = cols())) %>% 
    bind_rows
}

participants = load_data('participants')
multi_raw = load_data('multi-recall')

multi = multi_raw %>% 
    filter(!practice) %>%
    group_by(wid) %>% 
    filter(n() == 19) %>% 
    left_join(select(participants, wid, version)) %>% 
    ensure_column(c("primed", "primed_word")) %>% 
    mutate(
        response_type = factor(response_type, 
            levels=c("correct", "intrusion", "other", "timeout", "empty"),
            # labels=c("Correct", "Intrusion", "Other")
        ),
        correct = response_type == "correct",
        rt = typing_rt,
        presentation_times = map(presentation_times, fromJSON),
        first_pres_time = map_dbl(presentation_times, 1, .default=NaN),
        second_pres_time = map_dbl(presentation_times, 2, .default=NaN),
        third_pres_time = map_dbl(presentation_times, 3, .default=NaN),
        fourth_pres_time = map_dbl(presentation_times, 4, .default=NaN),
        choose_first = word == first_word,
        n_pres = lengths(presentation_times),
        odd_pres = mod(n_pres, 2) == 1,
        last_word = if_else(odd_pres, first_word, second_word),
        last_pres = if_else(n_pres %% 2 == 1, "first", "second"),
        chosen_word = if_else(choose_first, first_word, second_word),
        choose_last_seen = last_word == chosen_word,
        presentation_times_first = map(presentation_times, ~ .x[c(T, F)]),
        presentation_times_second = map(presentation_times, ~ .x[c(F, T)]),
        total_first = map_dbl(presentation_times_first, ~sum(unlist(.x)), .default=0),
        total_second = replace_na(map_dbl(presentation_times_second, ~sum(unlist(.x)), .default=0), 0),
        prop_first = (total_first) / (total_first + total_second),
        trial_num = row_number(),
        first_primed = primed_word == first_word,
    )


simple_raw = simple = load_data('simple-recall') %>% 
    group_by(wid) %>%
    mutate(trial_num = row_number()) %>%
    filter(!practice) %>% 
    # filter(n() == 79) %>% 
    mutate(
        typing_rt_z = zscore(typing_rt),
        response_type = factor(response_type, 
            levels=c("correct", "intrusion", "other", "timeout", "empty"),
            # labels=c("Correct", "Intrusion", "Other")
        ),
        # word_type = factor(word_type, levels=c("low", "high"), labels=c("Low", "High")),
        total_time = rt + type_time,
        correct = response_type == "correct",
        base_rt = rt,
        rt = replace_na(typing_rt, 15000),
        logrtz = zscore(log(rt))
    ) %>% 
    rowwise() %>% mutate(rt = min(rt, 15000)) %>% ungroup()
```


```{r}

pretest = simple %>% 
    filter(block == max(block)) %>% 
    rename(pre_correct = correct) %>% 
    mutate(pre_logrt = if_else(pre_correct, log(rt), NaN)) %>% 
    mutate(raw_strength = -if_else(pre_correct, log(rt), log(15000))) %>% 
    group_by(wid, word) %>% 
    summarise(across(c(pre_correct, pre_logrt, raw_strength), mean, na.rm=T)) %>%
    group_by(wid) %>%
    mutate(across(c(pre_correct, pre_logrt, raw_strength), zscore, .names="{.col}_z")) %>% 
    rename(strength = raw_strength_z)

df = multi %>% 
    select(-contains("strength")) %>% 
    left_join(pretest, c("wid", "first_word" = "word")) %>% 
    left_join(pretest, c("wid", "second_word" = "word"), suffix=c("_first", "_second")) %>% 
    mutate(
        name = "Human",
        rel_pre_correct = pre_correct_first - pre_correct_second,
        rel_pre_logrt = pre_logrt_first - pre_logrt_second,
        rel_strength = (strength_first - strength_second) / sqrt(2),  # keep it standardized
        chosen_strength = if_else(choose_first, strength_first, strength_second),
    )
# df = multi %>% left_join(pretest)
```

```{r}
avg_ptime = long %>% group_by(name,wid) %>% 
    filter(last_fix == 0) %>% 
    # filter(presentation == 1) %>% 
    summarise(duration_mean=mean(duration), duration_sd=sd(duration))

df = df %>% 
    left_join(avg_ptime) %>% 
    mutate(
        first_pres_time_z = (first_pres_time - duration_mean)/duration_sd,
        second_pres_time_z = (second_pres_time - duration_mean)/duration_sd,
        third_pres_time_z = (third_pres_time - duration_mean)/duration_sd,
        fourth_pres_time_z = (fourth_pres_time - duration_mean)/duration_sd,
    )


keep_acc = multi %>% 
    group_by(wid) %>% 
    summarise(accuracy=mean(correct)) %>% 
    filter(accuracy > 0.5) %>% 
    with(wid)

df = df %>% filter(wid %in% keep_acc)
df = df %>% filter(response_type == "correct")
```


# Fixation durations

## First fixation

```{r first, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    # filter(response_type == "correct") %>% 
    filter(n_pres >= 2) %>% 
    regress(pre_correct_first, first_pres_time_z) #plot
```

```{r first, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    # filter(response_type == "correct") %>% 
    filter(n_pres >= 2) %>% 
    regress(pre_logrt_first, first_pres_time_z) #plot
```

## Second fixation

```{r second, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 3) %>% 
    regress(pre_correct_first, second_pres_time_z) # plot
```

```{r second, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 3) %>% 
    regress(pre_logrt_first, second_pres_time_z) # plot
```

## Third fixation

```{r third, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    # group_by(wid) %>% mutate(third_pres_time_z = zscore(third_pres_time_z)) %>% ungroup() %>% 
    filter(n_pres >= 4) %>% 
    regress(rel_pre_correct, third_pres_time_z, mixed=MIXED_DURATIONS) # plot
```

```{r third, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    # group_by(wid) %>% mutate(third_pres_time_z = zscore(third_pres_time_z)) %>% ungroup() %>% 
    filter(n_pres >= 4) %>% 
    regress(pre_logrt_second, third_pres_time_z, mixed=MIXED_DURATIONS) # plot
```

# Choice

```{r first, fig.width=WIDTH, fig.height=HEIGHT}
df %>%
    ggplot(aes(rel_pre_correct, 1*choose_first)) +
    stat_summary(fun.data=mean_cl_boot)
```

```{r first, fig.width=WIDTH, fig.height=HEIGHT}
df %>%
    ggplot(aes(rel_pre_logrt, 1*choose_first)) +
    stat_summary_bin(fun.data=mean_cl_boot)
```

# Overall fixation proportion

```{r fix-prop, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(rel_strength, prop_first) + ylim(0,1)
```

## Last-fixation effect

```{r last-confound, fig.width=WIDTH, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    regress_interaction(rel_strength, last_pres, prop_first)
```

## Strength predicts last fixation 

```{r last-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    mutate(last_pres_first = as.numeric(last_pres == "first")) %>% 
    regress(rel_strength, last_pres_first)
```

## Last fixations are longer

```{r fix-by-final, fig.width=WIDTH, fig.height=HEIGHT}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_grid(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final")) +
    ylab("Duration")

last_diff = long %>% 
    filter(name == "Human") %>% 
    with(tapply(duration, last_fix, mean)) %>% 
    diff

long %>% 
    filter(name == "Human") %>% 
    mutate(is_last = int(last_fix==1)) %>% 
    lmer(duration ~ is_last + (is_last|wid), data=.) %>% 
    summ

```

# Sanity checks for evidence accumulation

These plots test basic predictions of the evidence
accumulation model, that is, effects that come out in the random model. 

These plots only include correct trials.

## Probability of remembering first word

```{r remember-first, fig.width=WIDTH, fig.height=HEIGHT}
df %>%
    filter(response_type == "correct") %>% 
    mutate(choose_first = int(choose_first)) %>% 
    regress(strength_first, choose_first, logistic=TRUE) +
    ylab("Prob Select First Cue") + ylim(0, 1)
```

## Reaction time by chosen strength

```{r rt-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    regress(chosen_strength, rt)
```

```{r}
human %>%
    filter(response_type == "correct") %>% 
    # glmer(rt ~ chosen_strength + (chosen_strength|wid), data=., family=gaussian) %>% 
    lm(rt ~ chosen_strength, data=.) %>% 
    summ
```

## Last fixation duration by strength

```{r last-duration-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    filter(n_pres > 0) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    ) %>% 
    regress(last_strength, last_pres_time)
```

```{r}
long %>% filter(name == "Human") %>% 
    mutate(rel_strength_fixated = if_else(fix_first==1, rel_strength, -rel_strength)) %>% 
    mutate(last_fix = factor(last_fix)) %>% 
    regress_interaction(rel_strength_fixated, last_fix, duration) #plot
```

# Miscellaneous

## Response types

Note: The model can only predict correct answers and timeouts.

```{r responses, fig.width=WIDTH, fig.height=HEIGHT}
raw_df %>% 
    with((proportions(table(name, response_type), margin=1))) %>% 
    kable(digits=2)

```

## Reaction time

```{r rt, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    ggplot(aes(rt)) +
    geom_density() +
    facet_grid(~name) +
    labs(x="Reaction Time", y="Density")
```


## Number of fixations

```{r nfix, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres < 10) %>% 
    ggplot(aes(n_pres, ..prop..)) +
    geom_bar() +
    facet_grid(~name) +
    labs(x="Number of Fixations", y="Proportion of Trials")
```

## All fixation duration

```{r all-fix, fig.width=WIDTH, fig.height=HEIGHT}
long %>% 
    filter(presentation < 6) %>% 
    ggplot(aes(presentation, duration, color=as_factor(last_fix))) +
    stat_summary(fun.data=mean_cl_boot) +
    facet_grid(~name)
```


r
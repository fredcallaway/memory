---
title: Rational metacognition in memory (Pre-registered dataset)
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
---

```{r, include=FALSE}
VERSIONS = c('v9.0')
knitr::opts_chunk$set(
    fig.path="figs/",
    results='asis', warning=FALSE, message=FALSE, fig.width=5, fig.height=4, fig.align="center"
)
```

## Experiment
- Two rounds of training and pre-test
- No feedback in any pre-test trials
- Word stimuli are selected randomly (not selecting high/low recall probability and concreteness)
- Distractor task comes before final pre-test
- Strength is measured by accuracy and reaction time in the last pre-test round (two trials per pair)
- Version(s): `r paste(VERSIONS)`

## Analysis
```{r setup, echo=FALSE}
OPTIMAL_VERSION = "optimal_prior"
DROP_HALF = FALSE
DROP_ACC = TRUE
DROP_ERROR = TRUE
NORMALIZE_FIXATIONS = TRUE
MIXED_DURATIONS = TRUE
source("setup.r")
source("load_data.r")
if (!MIXED_DURATIONS) info("Using fixed effects models for fixations")
```

# Probability of choosing the primed word

```{r}
multi %>% 
    ggplot(aes(first_primed, as.numeric(choose_first))) +
    stat_summary(fun.data=mean_cl_boot)
```


# Overall fixation proportion

```{r}
multi %>% 
    filter(n_pres>1) %>% 
    ggplot(aes(rel_strength, prop_first, color=first_primed)) +
    geom_smooth()
```

```{r}
multi %>% 
    filter(n_pres>1) %>% 
    ggplot(aes(first_primed, prop_first)) +
    stat_summary(fun.data=mean_cl_boot)
```


# Fixation durations

## First fixation

```{r first}
human %>%
    filter(n_pres >= 2) %>% 
    ggplot(aes(first_primed, first_pres_time)) +
    stat_summary(fun.data=mean_cl_boot)

human %>% 
    filter(n_pres >= 2) %>% 
    lmer(first_pres_time ~ first_primed  + (first_primed|wid), data=.) %>% 
    summ
```

## Second fixation

```{r second}
human %>% 
    filter(n_pres >= 3) %>% 
    ggplot(aes(first_primed, second_pres_time)) +
    stat_summary(fun.data=mean_cl_boot)

human %>% 
    filter(n_pres >= 3) %>% 
    lmer(second_pres_time ~ first_primed  + (first_primed|wid), data=.) %>% 
    summ
```

## Third fixation

```{r third}
human %>% 
    filter(n_pres >= 4) %>% 
    ggplot(aes(first_primed, third_pres_time)) +
    stat_summary(fun.data=mean_cl_boot)

human %>% 
    filter(n_pres >= 4) %>% 
    lmer(third_pres_time ~ first_primed  + (first_primed|wid), data=.) %>% 
    summ
```


```{r}
load_data('survey')$Q0
```

# Fixation time course

```{r, time-course, fig.width=WIDTH, fig.height=2.9}

normalized_timestep = function(long) {
    long %>% 
        group_by(trial_id) %>%
        # this somewhat complex method ensures that all trials have exactly 100 steps
        # (this isn't true if you just round duration, as I did initially)
        mutate(percentage_complete = round(100*cumsum(duration / sum(duration)))) %>% 
        mutate(n_step = diff(c(0, percentage_complete))) %>% 
        uncount(n_step) %>% 
        group_by(trial_id) %>% 
        mutate(normalized_timestep = row_number())
}

x %>% 
    left_join(select(human, trial_id, first_primed)) %>% 
    mutate(fix_primed = 1*(fix_first == first_primed)) %>% 
    normalized_timestep


```

```{r}
long %>% 
    filter(name == 'Human') %>% 
    left_join(select(human, trial_id, first_primed)) %>% 
    mutate(fix_primed = 1*(fix_first == first_primed)) %>% 
    normalized_timestep %>% 
    drop_na(strength_diff) %>% 
    ggplot(aes(normalized_timestep/100, fix_primed)) +
    geom_smooth(se=F) + 
    ylim(0, 1) +
    facet_grid(~name) +
    labs(x="Normalized Time", y="Probability Fixate Primed Cue", color="Strength Difference") +
    geom_hline(yintercept=0.5) +
    theme(legend.position="top")
```

# Overall fixation proportion

```{r fix-prop, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(n_pres >= 2) %>% 
    regress(rel_strength, prop_first)
```

## Last-fixation effect

```{r last-confound, fig.width=WIDTH, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    regress_interaction(rel_strength, last_pres, prop_first)
```

## Strength predicts last fixation 

```{r last-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    mutate(last_pres_first = as.numeric(last_pres == "first")) %>% 
    regress(rel_strength, last_pres_first)
```

## Last fixations are longer

```{r fix-by-final, fig.width=WIDTH, fig.height=HEIGHT}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_grid(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final")) +
    ylab("Duration")

last_diff = long %>% 
    filter(name == "Human") %>% 
    with(tapply(duration, last_fix, mean)) %>% 
    diff

long %>% 
    filter(name == "Human") %>% 
    mutate(is_last = int(last_fix==1)) %>% 
    lmer(duration ~ is_last + (is_last|wid), data=.) %>% 
    summ

```


# Sanity checks for evidence accumulation

These plots test basic predictions of the evidence
accumulation model, that is, effects that come out in the random model. 

These plots only include correct trials.

## Probability of remembering first word

```{r remember-first, fig.width=WIDTH, fig.height=HEIGHT}
df %>%
    filter(response_type == "correct") %>% 
    mutate(choose_first = int(choose_first)) %>% 
    regress(strength_first, choose_first, logistic=TRUE) +
    ylab("Prob Select First Cue") + ylim(0, 1)
```

## Reaction time by chosen strength

```{r rt-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    regress(chosen_strength, rt)
```

```{r}
human %>%
    filter(response_type == "correct") %>% 
    # glmer(rt ~ chosen_strength + (chosen_strength|wid), data=., family=gaussian) %>% 
    lm(rt ~ chosen_strength, data=.) %>% 
    summ
```

## Last fixation duration by strength

```{r last-duration-strength, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    filter(response_type == "correct") %>% 
    filter(n_pres > 0) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    ) %>% 
    regress(last_strength, last_pres_time)
```

# Miscellaneous

## Response types

Note: The model can only predict correct answers and timeouts.

```{r responses, fig.width=WIDTH, fig.height=HEIGHT}
raw_df %>% 
    with((proportions(table(name, response_type), margin=1))) %>% 
    kable(digits=2)

```

## Reaction time

```{r rt, fig.width=WIDTH, fig.height=HEIGHT}
df %>% 
    ggplot(aes(rt)) +
    geom_density() +
    facet_grid(~name) +
    labs(x="Reaction Time", y="Density")
```


## Number of fixations

```{r nfix}
human %>% 
    filter(n_pres < 10) %>% 
    ggplot(aes(n_pres, ..prop..)) +
    geom_bar() +
    facet_grid(~name) +
    labs(x="Number of Fixations", y="Proportion of Trials")

```


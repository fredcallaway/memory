---
title: Rational metacognition in memory
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
  output:
    pdf_document:
      latex_engine: xelatex
---

# Results

```{r setup, include=FALSE}
source("setup.r")
source("load_data.r")
raw_df = bind_rows(
    read_sim("optimal_prior"), 
    read_sim("rand_gamma"),
    multi %>% 
        mutate(name = "human") %>% 
        filter(trial_num > 10)
)

df = raw_df %>% 
    mutate(
        name = recode_factor(name, .ordered=T,
            # "Optimal" = "optimal",
            "optimal_prior" = "Optimal",
            "human" = "Human",
            "rand_gamma" = "Random",
        ),
        last_pres = if_else(n_pres %% 2 == 1, "first", "second")
    )

optimal = filter(df, name == "Optimal")
random = filter(df, name == "Random")
human =filter(df, name == "Human")
```

## Probability of remembering first word

As a sanity check, we first ask if our memory strength index predicts
participants choices about which image to recall. We operationalize memory
strength as the within-participant Z-scored, mean log 2AFC RT (that's a mouthful!)
If this index tracks memory strength, we should see that the probability that a
target is chosen for recollection should depend on the difference in "strength" between
the two cues.

Note: For the model, strength corresponds to the $p$ parameter. Here, we
simply Z-score $p$ to put it in roughly the same units. The assumption that
$p$ is linearly related to log reaction time is almost certainly wrong, but
it's enough to get a sense of qualitative model predictions.


```{r,remember-first, fig.width=7.5, fig.height=3}
df %>% 
    ggplot(aes(rel_strength, as.numeric(choose_first))) + 
    geom_smooth(method = "glm", method.args = list(family = "binomial"), formula=y~x) +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="First Cue Memory Strength", y="Prob Select First Cue")

human %>% 
    lmer(choose_first ~ rel_strength + (rel_strength|wid), data=.) %>% summ
# lmer(choose_first ~ strength_first + strength_second + (strength_first + strength_second |wid), data=X) %>% summ
```

Note: unless otherwise stated, all regression tables are maximal linear mixed effects models
(random slopes and intercepts) applied to the human data. 
Plotted regression lines are fixed effects only.

## Fixation proportion by relative memory strength

The simplest test of rational memory: do people spend more time looking at the cue
that they have a stronger memory of? This analysis only considers trials where
both cues are seen.

```{r, fix-prop, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(rel_strength, prop_first)) + 
    geom_smooth(method = "lm", formula="y~x") +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Proportion Fixate First")

X = df %>% filter(n_pres >= 2 & name == "Human")
lmer(choose_first ~ rel_strength + (rel_strength|wid), data=X) %>% summ
```

They do! ðŸŽ‰ But hold on, there's a small but significant effect in the random model.
What's going on there?

### Last fixation effect

People remember the thing they look at last
`r round(100 * mean(multi$choose_last_seen, na.rm=T))`%
of the time. In value-based decision making, it has been suggested that
this last-fixation effect could explain away what looks to be evidence for
adaptive attention allocation. Briefly, the last fixation is
correlated with both fixation proportion and relative strength, and this
could be entirely driving the correlation between strength and fixation proportion.
See [here](last-fixation-21-06-01.html) for a 
more thorough explanation.

```{r, last-fix, fig.width=7.5, fig.height=3.5}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(rel_strength, prop_first, color=last_pres)) + 
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    theme(legend.position="top") +
    labs(x="Relative Memory Strength", y="Proportion Fixate First Cue", color="Last Fixation")

X = df %>% filter(n_pres > 1 & name == "Human")
lmer(prop_first ~ rel_strength * last_pres + (rel_strength * last_pres | wid), data=X) %>% summ
```

The effect of relative memory strength on fixation proportion is a lot weaker when
we control for the effect of the last fixation, but it remains significant.


## First fixation duration {#first-fix}

Given the complications with the total fixation duration, 
the duration of the first fixation is potentially a more reliable cue.
The model makes a strong prediction here, and it probably isn't confounded
by the last fixation effect.

Consider only the trials with more than one fixation.
Do participants switch away from the first image more quickly when they have
a worse memory of it?

```{r, first-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(strength_first, first_pres_time)) +
    # geom_smooth(method="lm") + 
    geom_smooth() + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="First Cue Memory Strength", y="First Fixation Time")

human %>% 
    filter(n_pres >= 2) %>% 
    lmer(first_pres_time ~ strength_first + (strength_first|wid), data=.) %>% summ

```

The fixed effect is in the opposite of the predicted direction, but the mixed
effects gives an almost significant result in the correct direction. Weird.


## Second fixation duration

We can do a similar analysis for the second fixation duration. In this case,
however, the duration may depend on the strength of both the first and second cues.
As before, we exclude final fixations in this plot (i.e. excluding trials less than
three fixations).

```{r, second-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 3) %>% 
    ggplot(aes(rel_strength, second_pres_time)) +
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Second Fixation Time")

X = human %>% 
     filter(n_pres >= 3) 

X %>% lmer(second_pres_time ~ rel_strength + (rel_strength|wid), data=.) %>% summ
# X %>% lmer(second_pres_time ~ strength_first + strength_second + (strength_first + strength_second|wid), data=.) %>% summ
```

Looks good! People more quickly switch back to the first-seen cue when they have a
stronger memory for that cue compared to the second-seen cue.


## Third fixation duration

Same thing for the third fixation.

```{r, third-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 4) %>% 
    ggplot(aes(rel_strength, third_pres_time)) +
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Third Fixation Time")

human %>% 
    filter(n_pres >= 4) %>% 
    lmer(third_pres_time ~ rel_strength + (rel_strength|wid), data=.) %>% summ
```

This is a suspiciously strong effect. Might be some selection effects here.


## Fixation durations by position

```{r, fix-by-final, fig.width=7.5, fig.height=3}
make_fixations = function(df) {
    df %>% 
        ungroup() %>% 
        filter(n_pres >= 1) %>% 
        select(name, rel_strength, presentation_times, n_pres) %>% 
        mutate(
            trial = row_number(),
            strength_diff = cut(abs(rel_strength), 
                                c(0, 0.35, 1.25, 10),
                                # quantile(abs(rel_strength), c(0, 0.2, 1.),  na.rm = T),
                                labels=c("small", "moderate", "large"),
                                ordered=T)
        ) %>% 
        unnest_longer(presentation_times, "duration", indices_to="presentation") %>% 
        mutate(
            last_fix = as.numeric(presentation == n_pres),
            fix_first = presentation %% 2,
            fix_stronger = as.numeric(fix_first == (rel_strength > 0)),
            duration = if_else(name == "Human", as.integer(duration), as.integer(duration * 250)),
        )
}

long %>% 
    group_by(name, last_fix) %>% 
    summarise(mean(duration))

long = df %>% 
    group_by(name) %>%
    slice_sample(n=2000) %>% 
    make_fixations
```

### Final vs non-final

```{r, fix-by-final, fig.width=7.5, fig.height=3}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_wrap(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final"))
```

### First, second, middle, final

```{r, fix-by-type, fig.width=7.5, fig.height=3}
long %>% 
    mutate(fixation_type = case_when(
        presentation == n_pres ~ "final",
        presentation == 1 ~ "first",
        presentation == 2 ~ "second",
        presentation > 2 ~ "middle",
    ) %>% fct_relevel("first", "second", "middle", "final")) %>% 
    ggplot(aes(fixation_type, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_wrap(~name)
    # scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final"))
```

### Number and finality
```{r, fix-by-number, fig.width=7.5, fig.height=3.3}
long %>% 
    filter(presentation <= 6) %>% 
    ggplot(aes(presentation, duration, color=factor(last_fix))) +
    stat_summary(fun.data=mean_cl_boot) +
    facet_wrap(~name) +
    theme(legend.position="top")
```

### Just number and finality
```{r, fix-by-number, fig.width=7.5, fig.height=3.3}
long %>% 
    filter(presentation <= 6) %>% 
    ggplot(aes(presentation, duration)) +
    stat_summary(fun.data=mean_cl_boot) +
    facet_wrap(~name) +
    theme(legend.position="top")
```

## Time course

Finally, we can make a plot similar to the initial model prediction.
How does the probability of fixating the more-memorable option change
over the course of the trial? We normalize the x axis by the duration
of the trial to reduce noise (it's really messy with raw time).

```{r, time-course, fig.width=7.5, fig.height=3.5}

normalized_timestep = function(long) {
    long %>% 
        group_by(trial) %>%
        mutate(prop_duration = duration / sum(duration)) %>% 
        ungroup() %>% 
        mutate(n_step=round(prop_duration * 100)) %>% 
        uncount(n_step) %>% 
        group_by(trial) %>% 
        mutate(normalized_timestep = row_number())
}

long = make_fixations(df)
nts = normalized_timestep(long)
nts %>% 
    drop_na(strength_diff) %>% 
    ggplot(aes(normalized_timestep/100, fix_stronger, group = strength_diff, color=strength_diff)) +
    geom_smooth(se=F) + 
    ylim(0, 1) +
    facet_wrap(~name) +
    labs(x="Normalized Time", y="Probability Fixate Stronger Cue", color="Strength Difference") +
    geom_hline(yintercept=0.5) +
    theme(legend.position="top")

```

Note that the spike in the Random model is the last-fixation effect. The model always
recalls the last-fixated cue, and it's more likely to recall the target with higher strength.

For the trials where one cue has a substantially stronger memory, we see a
pretty reliable increase in probability of fixating the stronger cue over the
course of the trial. It does look like people are slower on the uptake compared
to the optimal model, suggesting that people might have some kind of "metacognitive lag".



<!-- In value-based decision making tasks, we simply ask participants for liking ratings. -->





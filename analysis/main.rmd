---
title: Random commitment model qualitative comparison
date: "`r Sys.Date()`"
author: "fredcallaway"
output:
  rmdformats::robobook:
    code_folding: hide
    self_contained: true
  output:
    pdf_document:
      latex_engine: xelatex
---

# Changes

- In the model, strength is now proportional to $log(p)$ (previously just $p$).
  The motivation for this is that reaction time in a single cue recall task 
  is proportional to $1 / p$, which implies $log(p) = log(C) - log(t)$ for some
  unknown constant $C$. Because our human strength measure is in units of $log(t)$,
  it makes sense for the model strength to be proportional $log(p)$.
- New random model: At the beginning of the trial, the "Random commitment"
  model samples the maximum number of fixations from the empirical
  distribution. Each fixation duration is drawn from the empirical
  distribution of non-final fixations. When the maximum number of fixations
  has been reached, the model stays on the currently fixated cue until the
  target is recalled or the trial time limit is reached (15 seconds).

# Main Results

```{r setup, include=FALSE}
source("setup.r")
source("load_data.r")
raw_df = bind_rows(
    read_sim("optimal_prior", noise_sd=3),
    read_sim("empirical_commitment", noise_sd=3),
    # read_sim("rand_gamma"),
    multi %>% 
        mutate(name = "human") %>% 
        filter(trial_num > 10)
)

df = raw_df %>% 
    filter(response_type %in% c("correct", "timeout")) %>%
    mutate(
        name = recode_factor(name, .ordered=T,
            # "Optimal" = "optimal",
            "optimal_prior" = "Optimal",
            "human" = "Human",
            "empirical_commitment" = "Random",
            # "rand_gamma" = "Random",
        ),
        last_pres = if_else(n_pres %% 2 == 1, "first", "second")
    )

optimal = filter(df, name == "Optimal")
random = filter(df, name == "Random")
human = filter(df, name == "Human")
```

## Probability of remembering first word

As a sanity check, we first ask if our memory strength index predicts
participants choices about which image to recall. We operationalize memory
strength as the within-participant Z-scored, mean log 2AFC RT (that's a mouthful!)
If this index tracks memory strength, we should see that the probability that a
target is chosen for recollection should depend on the difference in "strength" between
the two cues.

Note: For the model, strength corresponds to the $p$ parameter. Here, we
simply Z-score $p$ to put it in roughly the same units. The assumption that
$p$ is linearly related to log reaction time is almost certainly wrong, but
it's enough to get a sense of qualitative model predictions.


```{r,remember-first, fig.width=7.5, fig.height=3}
df %>%
    ggplot(aes(rel_strength, as.numeric(choose_first))) + 
    geom_smooth(method = "glm", method.args = list(family = "binomial"), formula=y~x) +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="First Cue Memory Strength", y="Prob Select First Cue")

human %>% 
    lmer(choose_first ~ rel_strength + (rel_strength|wid), data=.) %>% summ
# lmer(choose_first ~ strength_first + strength_second + (strength_first + strength_second |wid), data=X) %>% summ
```

Note: unless otherwise stated, all regression tables are maximal linear mixed effects models
(random slopes and intercepts) applied to the human data. 
Plotted regression lines are fixed effects only.


## Fixation proportion by relative memory strength

The simplest test of rational memory: do people spend more time looking at the cue
that they have a stronger memory of? This analysis only considers trials where
both cues are seen.

```{r, fix-prop, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(rel_strength, prop_first)) + 
    geom_smooth(method = "lm", formula="y~x") +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Proportion Fixate First")

X = df %>% filter(n_pres >= 2 & name == "Human")
lmer(choose_first ~ rel_strength + (rel_strength|wid), data=X) %>% summ
```

They do! ğŸ‰ But hold on, there's a small but significant effect in the random model.
What's going on there?

### Last fixation effect

People remember the thing they look at last
`r round(100 * mean(multi$choose_last_seen, na.rm=T))`%
of the time. In value-based decision making, it has been suggested that
this last-fixation effect could explain away what looks to be evidence for
adaptive attention allocation. Briefly, the last fixation is
correlated with both fixation proportion and relative strength, and this
could be entirely driving the correlation between strength and fixation proportion.
See [here](last-fixation-21-06-01.html) for a 
more thorough explanation.

```{r, last-fix, fig.width=7.5, fig.height=3.5}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(rel_strength, prop_first, color=last_pres)) + 
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    theme(legend.position="top") +
    labs(x="Relative Memory Strength", y="Proportion Fixate First Cue", color="Last Fixation")

X = df %>% filter(n_pres > 1 & name == "Human")
lmer(prop_first ~ rel_strength * last_pres + (rel_strength * last_pres | wid), data=X) %>% summ
```

The effect of relative memory strength on fixation proportion is a lot weaker when
we control for the effect of the last fixation, but it remains significant.


## First fixation duration {#first-fix}

Given the complications with the total fixation duration, 
the duration of the first fixation is potentially a more reliable cue.
The model makes a strong prediction here, and it probably isn't confounded
by the last fixation effect.

Consider only the trials with more than one fixation.
Do participants switch away from the first image more quickly when they have
a worse memory of it?

```{r, first-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 2) %>% 
    ggplot(aes(strength_first, first_pres_time)) +
    # geom_smooth(method="lm") + 
    geom_smooth() + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="First Cue Memory Strength", y="First Fixation Time")

human %>% 
    filter(n_pres >= 2) %>% 
    lmer(first_pres_time ~ strength_first + (strength_first|wid), data=.) %>% summ
```

The fixed effect is in the opposite of the predicted direction, but the mixed
effects gives an almost significant result in the correct direction. Weird.


## Second fixation duration

We can do a similar analysis for the second fixation duration. In this case,
however, the duration may depend on the strength of both the first and second cues.
As before, we exclude final fixations in this plot (i.e. excluding trials less than
three fixations).

```{r, second-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 3) %>% 
    ggplot(aes(rel_strength, second_pres_time)) +
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Second Fixation Time")

X = human %>% 
     filter(n_pres >= 3) 

X %>% lmer(second_pres_time ~ rel_strength + (rel_strength|wid), data=.) %>% summ
# X %>% lmer(second_pres_time ~ strength_first + strength_second + (strength_first + strength_second|wid), data=.) %>% summ
```

Looks good! People more quickly switch back to the first-seen cue when they have a
stronger memory for that cue compared to the second-seen cue.


## Third fixation duration

Same thing for the third fixation.

```{r, third-fix, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres >= 4) %>% 
    ggplot(aes(rel_strength, third_pres_time)) +
    geom_smooth(method="lm") + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs(x="Relative Memory Strength", y="Third Fixation Time")

human %>% 
    filter(n_pres >= 4) %>% 
    lmer(third_pres_time ~ rel_strength + (rel_strength|wid), data=.) %>% summ
```

This is a suspiciously strong effect. Might be some selection effects here.

```{r, fig.width=7.5, fig.height=3}
make_fixations = function(df) {
    df %>% 
        ungroup() %>% 
        filter(n_pres >= 1) %>% 
        select(name, rel_strength, presentation_times, n_pres) %>% 
        mutate(
            trial = row_number(),
            strength_diff = cut(abs(rel_strength), 
                                c(0, 0.35, 1.25, 10),
                                # quantile(abs(rel_strength), c(0, 0.2, 1.),  na.rm = T),
                                labels=c("small", "moderate", "large"),
                                ordered=T)
        ) %>% 
        unnest_longer(presentation_times, "duration", indices_to="presentation") %>% 
        mutate(
            last_fix = as.numeric(presentation == n_pres),
            fix_first = presentation %% 2,
            fix_stronger = as.numeric(fix_first == (rel_strength > 0)),
            # duration = if_else(name == "Human", as.integer(duration), as.integer(duration * 250)),
        )
}

long = df %>% 
    group_by(name) %>%
    slice_sample(n=2000) %>% 
    make_fixations
```

## Final vs non-final duration

Longer final fixations suggest that people commit to a cue at some point. This
is a cool finding because we see the opposite (shorter final fixations) in
value-based and perceptual decisions, typically explained as the result of
crossing a threshold cutting off the final fixations. The reason we see this
in the optimal model is that the accumulation is not just to identify
which target is more memorable and also to actually remembering it (perceptual
and value-based decisions only have the former).

```{r, fix-by-final, fig.width=7.5, fig.height=3}
long %>% 
    # filter(name == "Human") %>% 
    ggplot(aes(last_fix==1, duration)) + 
    stat_summary(fun.data=mean_cl_boot, geom="bar", fill="white", color="black") +
    stat_summary(fun.data=mean_cl_boot, geom="errorbar", width=0.2) +
    facet_wrap(~name) + 
    scale_x_discrete(name="Fixation Type", labels=c("Non-final", "Final"))
```

The random model result is interesting. The intention of the random
commmitment model was to capture this exact phenomenon. But it seems to have
way *over*-captured it. The reason this happens is (probably) that humans
don't actually randomly commit to a cue, but instead only commit when they are
reasonably sure they will remember it. Also, any such commitment is probably
not really a firm commitment. Anyway, what happens to this random model is
that it commits too early or on a bad cue, and then it takes forever to
remember it.

This might draw into question my decision to sample the commitment decision
based on the empirical number-of-fixations distribution. The only alternative
I can think of is to sample from a parametric distribution with some free 
parameter. Previously we discussed a probability of commiting on each fixation
which is equivalent to an Exponential distribution. But we don't have a good 
way to fit parameters...

## Time course

Finally, we can make a plot similar to the initial model prediction.
How does the probability of fixating the more-memorable option change
over the course of the trial? We normalize the x axis by the duration
of the trial to reduce noise (it's really messy with raw time).

```{r, time-course, fig.width=7.5, fig.height=3.5}

normalized_timestep = function(long) {
    long %>% 
        group_by(trial) %>%
        mutate(prop_duration = duration / sum(duration)) %>% 
        ungroup() %>% 
        mutate(n_step=round(prop_duration * 100)) %>% 
        uncount(n_step) %>% 
        group_by(trial) %>% 
        mutate(normalized_timestep = row_number())
}

optimal %>% with(table(response_type))

long = make_fixations(df)
nts = normalized_timestep(long)
nts %>% 
    drop_na(strength_diff) %>% 
    ggplot(aes(normalized_timestep/100, fix_stronger, group = strength_diff, color=strength_diff)) +
    geom_smooth(se=F) + 
    ylim(0, 1) +
    facet_wrap(~name) +
    labs(x="Normalized Time", y="Probability Fixate Stronger Cue", color="Strength Difference") +
    geom_hline(yintercept=0.5) +
    theme(legend.position="top")

```

Note that the spike in the Random model is the last-fixation effect. The model always
recalls the last-fixated cue, and it's more likely to recall the target with higher strength.

For the trials where one cue has a substantially stronger memory, we see a
pretty reliable increase in probability of fixating the stronger cue over the
course of the trial. It does look like people are slower on the uptake compared
to the optimal model, suggesting that people might have some kind of "metacognitive lag".

# Sanity checks for evidence accumulation

All these plots are testing really basic predictions of the evidence
accumulation model, that is, effects that come out in the random model. They
are all much weaker in humans than the model and some aren't even significant.
This suggests that we might need to make some adjustments to the base
accumulation model, especially if we wanted to do any real model fitting.


## Reaction time by chosen strength

```{r, fig.width=7.5, fig.height=3}
df %>% 
    ggplot(aes(chosen_strength, rt)) +
    geom_smooth() +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name)

lmer(rt ~ chosen_strength + (chosen_strength|wid), data=human) %>% summ
```

## Last fixation duration by strength

```{r, fig.width=7.5, fig.height=3}
X = df %>% 
    filter(n_pres > 0) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    )

X %>% 
    ggplot(aes(last_strength, last_pres_time,)) +
    geom_smooth() +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs()

X %>% filter(name == "Human") %>% 
    lmer(last_pres_time ~ last_strength + (last_strength|wid), data=.) %>% summ
```

## Last fixation duration by strength and presentation

```{r, fig.width=7.5, fig.height=3}
X = df %>% 
    filter(between(n_pres, 1, 4)) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    )

X %>% 
    ggplot(aes(last_strength, last_pres_time, group=n_pres, color=n_pres)) +
    geom_smooth() +
    stat_summary_bin(fun.data=mean_cl_boot, bins=5) + 
    facet_wrap(~name) +
    labs()

X %>% filter(name == "Human") %>% 
    lmer(last_pres_time ~ last_strength * n_pres + (1|wid), data=.) %>% summ
```



# Random stuff

## Timeout rate

```{r, fig.width=7.5, fig.height=3}
df %>% 
    ggplot(aes(response_type == "timeout", ..prop..)) +
    geom_bar(group=0) +
    facet_wrap(~name)

```

## Reaction time

```{r, fig.width=7.5, fig.height=3}
df %>% 
    ggplot(aes(rt)) +
    geom_density() +
    facet_wrap(~name)

```
## Number of fixations

```{r, fig.width=7.5, fig.height=3}
df %>% 
    filter(n_pres < 10) %>% 
    ggplot(aes(n_pres, ..prop..)) +
    geom_bar() +
    facet_wrap(~name)

```

## Final fixation - relative strength

```{r}
X = df %>% 
    filter(n_pres > 3) %>% 
    mutate(
        last_pres_time = map_dbl(presentation_times, last),
        last_rel_strength = if_else(last_pres == "first", rel_strength, 1 - rel_strength),
        last_strength = if_else(last_pres == "first", strength_first, strength_second)
    )

X %>% ggplot(aes(last_strength, last_pres_time)) + 
    stat_summary_bin(fun.data=mean_cl_boot, bins=10) +
    facet_wrap(~name) +
    geom_smooth(method='lm')

X %>% lmer(last_pres_time ~ last_rel_strength + (last_rel_strength|wid), data=.) %>% summ
```



